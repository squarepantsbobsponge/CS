以字节为粒度的动态管理

#  Project 2 malloc/free的实现

我们已经实现了以页为粒度的动态内存分配和释放。但是，我们在程序中使用的往往是以字节为粒度的动态内存管理机制，即我们可以分配和释放任意字节长度的内存。

在本项目中，同学们需要实现系统调用malloc和free。malloc用于分配任意字节的内存，free用于释放任意字节的内存。在实现了malloc和free后，同学们需要自行提供测例来测试malloc和free。根据测试方法和输出结果来解释自己程序的正确性。最后将结果截图并说说你是怎么做的

* malloc函数：
  * 输入字节数
  * 返回分配的地址

* 实现用户级调用函数
  注册系统调用

* 分配位置：

  用户态还是内核态，要在用户态用还是分配在用户态

  分配在用户态的哪个位置？

  线程的代码位置在内核吗？感觉还是在内核的位置，但是被映射到了用户态了

  怎么知道用户态空间用了多少，这里是用allocated管理

* 实现页的按字节管理

​	按链表管理内存，就是first_fit，把页化成链表管理，要是一个页不够再申请，这就要记录下当堆的页了（前面的页面的动态内存分配可以复用）

* 但是如何返回按字节的用户地址（这要了解一下具体的代码）

​    allocatePages会返回页的虚拟地址，感觉直接改低位页内偏移即可，但是按照块管理不太好管页内偏移的样子，具体看看lab7动态内存分配的代码

   感觉可以完全复用这个代码，改一下

   但是需要给进程加个属性了，加个堆池（放堆页）

## 实现Heap_pool

* 先给进程加个堆池属性（直接用地址池）

  * 这个First_fit池只有一个resources，改成数组版加个限制最多100页
  * 这个属性放在哪里，放在PCB，可行性，放在内核，系统调用跳内核态的，还有应该可以直接调用分配用户内存的函数
  * 属性的类型就是地址池

* 改造allocate：

  * 先把链表的初始化里面给他分配一个头节点 start的坏毛病改掉

  * 再把one的坏毛病合并到链表的初始化里面去，但是这个限制一个页的大小怎么在链表里面体现，初始化第一个洞的大小改为一个页的大小
    one可以现在初始化的时候初始化大小和是否分配和连接，但是这个开始地址留到分配堆页的时候改

  * 但是这个分配物理页，怎么分配到进程的用户空间，怎么拿到这个的虚拟地址，现在是想，现在直接在进程那边分好，传虚拟页地址给堆池管理，由堆池给出具体的字节位置（但是堆池无法控制所有页的信息，还是有点麻烦），看看能不能把实现搬到进程管理里面

    程序用户态地址空间：现在PCB里面有个虚拟地址的地址池（这里是针对running的程序，所以感觉可以不用搬到用户态）->然后从整个系统的物理地址池找页分给虚拟页，再建表

    manager这里有点玄学

* 改造realse

  * 要遍历这个堆池，找到这块空间在哪里，这个free要传字节吗，要的吧

## malloc的系统调用的实现

![image-20240712204512018](C:\Users\丁晓琪\AppData\Roaming\Typora\typora-user-images\image-20240712204512018.png)

奇怪的bug，只能拿char* 类型接受

不能在头文件里面定义变量，多次包含头文件会多次定义全局变量，引发重复定义错误

## 系统调用

![image-20240713000109224](C:\Users\丁晓琪\AppData\Roaming\Typora\typora-user-images\image-20240713000109224.png)

![image-20240713000145110](C:\Users\丁晓琪\AppData\Roaming\Typora\typora-user-images\image-20240713000145110.png)